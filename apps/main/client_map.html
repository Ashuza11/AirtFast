{% extends 'layouts/base.html' %}

{% block title %} Carte des Clients {% endblock title %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}

{% block content %}

    <div class="header bg-primary pb-6">
        <div class="container-fluid">
            <div class="header-body">
                <div class="row align-items-center py-4">
                    <div class="col-lg-6 col-7">
                        <h6 class="h2 text-white d-inline-block mb-0">Terrain</h6>
                        <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                                <li class="breadcrumb-item"><a href="{{ url_for('main_bp.index') }}"><i class="fas fa-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="{{ url_for('main_bp.client_management') }}">Clients</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Terrain</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid mt--6">
        <div class="row">
            <div class="col">
                <div class="card border-0">
                    <div id="map-canvas" class="map-canvas"
                         data-lat="{{ default_center_lat }}"
                         data-lng="{{ default_center_lng }}"
                         style="height: 600px;"></div>
                </div>
            </div>
        </div>

        {% include "includes/footer.html" %}

    </div>

{% endblock content %}

{% block javascripts %}
    {{ super() }}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Define custom default icon paths for Leaflet
        L.Marker.prototype.options.icon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        function initLeafletMap() {
            console.log("initLeafletMap started.");

            const mapDiv = document.getElementById('map-canvas');
            console.log("Map div:", mapDiv);

            if (!mapDiv) {
                console.error("Map div #map-canvas not found! Cannot initialize map.");
                return; // Stop execution if map div is not found
            }

            const defaultLat = parseFloat(mapDiv.dataset.lat);
            const defaultLng = parseFloat(mapDiv.dataset.lng);
            console.log("Default center:", defaultLat, defaultLng);

            if (isNaN(defaultLat) || isNaN(defaultLng)) {
                console.error("Invalid default center coordinates!");
                return;
            }

            const map = L.map('map-canvas').setView([defaultLat, defaultLng], 12);
            console.log("Leaflet map initialized:", map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            console.log("Tile layer added.");

            // CORRECTED: Removed | escapejs
            const clientLocations = JSON.parse('{{ client_locations | tojson | safe }}');
            console.log("Client Locations:", clientLocations);

            const markers = [];

            if (clientLocations && clientLocations.length > 0) {
                clientLocations.forEach(function(client) {
                    const marker = L.marker([client.lat, client.lng]).addTo(map);

                    const contentString = `
                        <div class="info-window-content">
                            <h5>${client.name}</h5>
                            <p><strong>Adresse:</strong> ${client.address}</p>
                            <p><strong>Téléphone Airtel:</strong> ${client.phone_airtel}</p>
                            <p><strong>Lat:</strong> ${client.lat.toFixed(6)}<br><strong>Long:</strong> ${client.lng.toFixed(6)}</p>
                        </div>
                    `;

                    marker.bindPopup(contentString);
                    markers.push(marker);
                });

                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                if (clientLocations.length === 1) {
                    map.setZoom(15);
                }
            } else {
                console.warn("No client locations found or provided. Skipping marker creation.");
            }

            console.log("initLeafletMap completed.");
            map.invalidateSize();
        }

        // Use a simpler and more robust DOMContentLoaded listener
        // This ensures the DOM is fully loaded before trying to find 'map-canvas'
        document.addEventListener('DOMContentLoaded', initLeafletMap);

    </script>
{% endblock javascripts %}