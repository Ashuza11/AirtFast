{% extends "layouts/base.html" %}

{% block title %} Vente Stock {% endblock %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    {# Render the Page Header #}
    {% set page_title = 'Vente Stock' %}
    {% set breadcrumb_items = [
        {'text': 'Stock', 'url': url_for('main_bp.vente_stock')},
        {'text': 'Vente stock', 'url': url_for('main_bp.vente_stock')}
    ] %}
    {% include 'includes/page_header.html' %}

    {# Table for displaying sales - MODIFIED #}
    <div class="container-fluid mt--6">
        <div class="col-xl-12">
            <div class="card">
                <div class="card-header border-0">
                    <div class="row align-items-center">
                        <div class="col">
                            <h3 class="mb-0">Historique des Ventes</h3>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                             <tr>
                                <th scope="col">ID Vente</th>
                                <th scope="col">Client</th>
                                <th scope="col">Vendeur</th>
                                <th scope="col">Détails des Articles</th>
                                <th scope="col">Total Dû (FC)</th>
                                <th scope="col">Argent Donné (FC)</th>
                                <th scope="col">Dette (FC)</th>
                                <th scope="col">Date & Heure</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# MODIFIED: Loop through pagination items #}
                            {% for sale in sales_pagination.items %} 
                            <tr>
                                <td>{{ sale.id }}</td>
                                <td>{{ sale.client.name if sale.client else sale.client_name_adhoc }}</td>
                                <td>{{ sale.vendeur.username }}</td>
                                <td>
                                    {% for item in sale.sale_items %}
                                    <div>
                                        <strong>{{ item.network.value|capitalize }}:</strong> {{ item.quantity }} unités @ {{ "{:,.2f}".format(item.price_per_unit_applied) }} FC
                                        - Sous-total: {{ "{:,.2f}".format(item.subtotal) }} FC
                                    </div>
                                    {% endfor %}
                                </td>
                                <td>{{ "{:,.2f}".format(sale.total_amount_due) }}</td>
                                <td>
                                    <span id="cash-paid-{{ sale.id }}">{{ "{:,.2f}".format(sale.cash_paid) }}</span>
                                    <button type="button" class="btn btn-sm btn-info btn-edit-cash ml-2" data-sale-id="{{ sale.id }}" data-current-cash="{{ sale.cash_paid }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                                <td><span id="debt-amount-{{ sale.id }}">{{ "{:,.2f}".format(sale.debt_amount) }}</span></td>
                                <td>{{ sale.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {# ... (Your actions dropdown remains the same) ... #}
                                     <div class="dropdown">
                                        <a class="btn btn-sm btn-icon-only text-light" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v" style="color: #5e72e4;"></i> 
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                                            <a class="dropdown-item" href="{{ url_for('main_bp.view_sale_details', sale_id=sale.id) }}">Détails</a>
                                            <a class="dropdown-item" href="{{ url_for('main_bp.edit_sale', sale_id=sale.id) }}">Modifier</a>
                                            <a class="dropdown-item text-danger" href="{{ url_for('main_bp.delete_sale', sale_id=sale.id) }}">Supprimer</a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Aucune vente enregistrée.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> {# End table-responsive #}

                {# --- ADD PAGINATION CONTROLS --- #}
                {% if sales_pagination.pages > 1 %}
                <div class="card-footer py-4">
                    <nav aria-label="...">
                        <ul class="pagination justify-content-end mb-0">
                            {# Previous Page Link #}
                            <li class="page-item {% if not sales_pagination.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{{ prev_url or '#' }}" tabindex="-1">
                                    <i class="fas fa-angle-left"></i>
                                    <span class="sr-only">Précédent</span>
                                </a>
                            </li>
                            
                            {# Page Number Links (using iter_pages for smart display) #}
                            {% for page_num in sales_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num != sales_pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main_bp.vente_stock', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <a class="page-link" href="#">{{ page_num }} <span class="sr-only">(current)</span></a>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}

                            {# Next Page Link #}
                            <li class="page-item {% if not sales_pagination.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{{ next_url or '#' }}">
                                    <i class="fas fa-angle-right"></i>
                                    <span class="sr-only">Suivant</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% endif %}
                {# --- END PAGINATION CONTROLS --- #}

            </div> 
        </div> 
    </div> 

    {# ... (Your Footer and Modal code remains the same) ... #}

{% endblock content %}

{% block javascripts %}
    {# ... (Your existing JavaScript remains the same) ... #}
{% endblock javascripts %}